<!DOCTYPE HTML>
<html><head><title>Poll.hs</title><meta charset="UTF-8"><link rel="stylesheet" type="text/css" href="../css/default.css"></head><body><h1><a href="root.html">/ </a>Poll.hs - watches files for changes, applying a tranform when modified</h1>
<p>Poll is triggered by the <code>--watch</code> flag to <code>lit</code>. It applies the <code>lit</code> command every time one of the files changes. Poll implements simple file polling and does not attempt to interface with the underlying event system. Afterall, <code>lit</code> is a simple utility.</p>
<p>An overview of the file:</p>
<pre><code>&lt;&lt; <a id="*" href="#*">*</a> &gt;&gt;=
&lt;&lt; <a href="#define_Poll_module">define Poll module</a> &gt;&gt;
&lt;&lt; <a href="#import_modules">import modules</a> &gt;&gt;
&lt;&lt; <a href="#watch_a_file">watch a file</a> &gt;&gt;
&lt;&lt; <a href="#apply_a_fun_if_the_file_changed">apply a fun if the file changed</a> &gt;&gt;
&lt;&lt; <a href="#retry_if_timing_error">retry if timing error</a> &gt;&gt;
</code></pre><p>Poll exposes only the watch functionality</p>
<pre><code>&lt;&lt; <a id="define_Poll_module" href="#define_Poll_module">define Poll module</a> &gt;&gt;=
<span class="kw">module</span> <span class="dt">Poll</span> 
( watch ) <span class="kw">where</span>
</code></pre><pre><code>&lt;&lt; <a id="import_modules" href="#import_modules">import modules</a> &gt;&gt;=
<span class="kw">import </span><span class="dt">System.Directory</span>
<span class="kw">import </span><span class="dt">Data.Time.Clock</span>
<span class="kw">import </span><span class="dt">Data.Time.Calendar</span>
<span class="kw">import </span><span class="dt">Control.Monad</span> (forever)
<span class="kw">import qualified</span> <span class="dt">Control.Concurrent</span> <span class="kw">as</span> <span class="dt">C</span>
<span class="kw">import </span><span class="dt">System.IO.Error</span>
</code></pre><p><code>watch</code> takes a function which operates on a file and performs an IO action indefinitely. In <code>lit</code>,
<code>fun</code> is all the file processing (writing Html, writing Code, etc) necessary for one file. <code>watch</code>
does not actually apply the transform but makes a request to <code>onChange</code> defined below.</p>
<pre><code>&lt;&lt; <a id="watch_a_file" href="#watch_a_file">watch a file</a> &gt;&gt;=
<span class="ot">watch ::</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()) <span class="ot">-&gt;</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
watch fun fs <span class="fu">=</span> 
    <span class="kw">let</span> 
        wait <span class="fu">=</span> C.threadDelay <span class="dv">1000000</span>
    <span class="kw">in</span> <span class="kw">do</span> 
    putStrLn <span class="st">&quot;starting..&quot;</span>
    mapM_ fun fs
    forever <span class="fu">$</span> (wait <span class="fu">&gt;&gt;</span> mapM_ (onChange fun) fs)
</code></pre><p><code>onChange</code> handles a function and a file. It checks to see if the file was saved recently. If so,
the function needs to be reapplied to the file. Otherwise, the function was previously applied, and
nothing needs to be done.</p>
<pre><code>&lt;&lt; <a id="apply_a_fun_if_the_file_changed" href="#apply_a_fun_if_the_file_changed">apply a fun if the file changed</a> &gt;&gt;=
<span class="ot">onChange ::</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()) <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
onChange fun file <span class="fu">=</span> <span class="kw">do</span>
    modified <span class="ot">&lt;-</span> retryAtMost <span class="dv">10</span> (getModificationTime file) 
    curTime <span class="ot">&lt;-</span> getCurrentTime 
    <span class="kw">let</span> diff <span class="fu">=</span> (diffUTCTime curTime modified)
    <span class="kw">if</span> diff <span class="fu">&lt;</span> <span class="dv">2</span> <span class="kw">then</span> fun file <span class="kw">else</span> return ()
</code></pre><p>Occasionally, a timing error occurs when the program tries to read the modification time. If the
file is in the process of being saved, it becomes unavailable. During which, the program returns
the error that the file does not exist. <code>retryAtMost n action</code> will ignore the error n times before
actually throwing the error.</p>
<pre><code>&lt;&lt; <a id="retry_if_timing_error" href="#retry_if_timing_error">retry if timing error</a> &gt;&gt;=
retryAtMost <span class="dv">1</span> action <span class="fu">=</span> catchIOError action (\e <span class="ot">-&gt;</span> ioError e)
retryAtMost times action <span class="fu">=</span> 
    <span class="kw">let</span>
        handle e <span class="fu">=</span> <span class="kw">if</span> isDoesNotExistError e 
            <span class="kw">then</span> C.threadDelay <span class="dv">50000</span> <span class="fu">&gt;&gt;</span> retryAtMost (times <span class="fu">-</span> <span class="dv">1</span>) action
            <span class="kw">else</span> ioError e
    <span class="kw">in</span> 
        catchIOError action handle 
</code></pre></body></html>